<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misinformation Detection Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .content-grid.full-width {
            grid-template-columns: 1fr;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .metric-card {
            text-align: center;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .flagged-item {
            border-left: 4px solid #e74c3c;
            padding: 16px;
            margin-bottom: 12px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .flagged-item.propaganda {
            border-left-color: #e74c3c;
        }

        .flagged-item.toxic {
            border-left-color: #e67e22;
        }

        .flagged-item.bot {
            border-left-color: #9b59b6;
        }

        .flagged-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .flagged-meta {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .flagged-content {
            color: #555;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .flagged-url {
            font-size: 0.8rem;
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 16px;
            color: #c33;
            text-align: center;
        }

        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .source-name {
            font-weight: 600;
        }

        .source-stats {
            display: flex;
            gap: 16px;
            font-size: 0.9rem;
            color: #666;
        }

        .success-rate {
            color: #27ae60;
            font-weight: 600;
        }

        .session-item {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .session-info h4 {
            margin-bottom: 4px;
        }

        .session-meta {
            font-size: 0.85rem;
            color: #666;
        }

        .session-stats {
            text-align: right;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        .api-status {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-left: 16px;
        }

        .api-status.online {
            background: #d4edda;
            color: #155724;
        }

        .api-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding-bottom: 8px;
            }
            
            .flagged-meta {
                flex-direction: column;
                gap: 4px;
            }

            .session-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .session-stats {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Configuration
        const API_BASE = 'http://localhost:5000';

        // Main Dashboard Component
        function Dashboard() {
            const [activeTab, setActiveTab] = useState('overview');
            const [data, setData] = useState({
                stats: null,
                flagged: [],
                sessions: [],
                summary: null
            });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            const [apiStatus, setApiStatus] = useState('checking');

            // Fetch data from API with better error handling
            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    setApiStatus('checking');

                    // Test API connection first
                    const healthCheck = await fetch(`${API_BASE}/`, { 
                        signal: AbortSignal.timeout(5000) 
                    });
                    
                    if (!healthCheck.ok) {
                        throw new Error('API is not responding');
                    }

                    setApiStatus('online');

                    // Fetch all data with individual error handling
                    const fetchWithFallback = async (url, fallback = null) => {
                        try {
                            const response = await fetch(url, { 
                                signal: AbortSignal.timeout(10000) 
                            });
                            if (!response.ok) throw new Error(`HTTP ${response.status}`);
                            return await response.json();
                        } catch (err) {
                            console.warn(`Failed to fetch ${url}:`, err.message);
                            return fallback;
                        }
                    };

                    const [stats, flagged, sessions, summary] = await Promise.all([
                        fetchWithFallback(`${API_BASE}/stats`, { 
                            total_flagged: 0, 
                            propaganda_count: 0, 
                            toxic_count: 0, 
                            bot_count: 0,
                            reliable_count: 0 
                        }),
                        fetchWithFallback(`${API_BASE}/flagged`, []),
                        fetchWithFallback(`${API_BASE}/monitoring/sessions?limit=10`, []),
                        fetchWithFallback(`${API_BASE}/monitoring/stats/summary`, {
                            total_sessions: 0,
                            total_articles_processed: 0,
                            overall_flagging_rate: 0,
                            average_scraping_success_rate: 0,
                            content_breakdown: {
                                propaganda: 0,
                                toxic: 0,
                                bots: 0,
                                total_problematic: 0
                            },
                            recent_sessions: []
                        })
                    ]);

                    setData({ stats, flagged, sessions, summary });
                    setLastUpdate(new Date());
                    setApiStatus('online');

                } catch (err) {
                    setError(err.message);
                    setApiStatus('offline');
                    console.error('API Error:', err);
                } finally {
                    setLoading(false);
                }
            };

            // Initial data load
            useEffect(() => {
                fetchData();
                // Auto-refresh every 30 seconds
                const interval = setInterval(fetchData, 30000);
                return () => clearInterval(interval);
            }, []);

            const tabs = [
                { id: 'overview', label: 'Overview', icon: 'üìä' },
                { id: 'flagged', label: 'Flagged Content', icon: 'üö©' },
                { id: 'analytics', label: 'Analytics', icon: 'üìà' },
                { id: 'sources', label: 'Sources', icon: 'üåê' },
                { id: 'sessions', label: 'Sessions', icon: '‚è±Ô∏è' }
            ];

            if (loading && !data.stats) {
                return (
                    <div className="dashboard">
                        <div className="loading">
                            <h2>Loading Dashboard...</h2>
                            <p>Fetching latest misinformation detection data</p>
                            <div className={`api-status ${apiStatus}`}>
                                API Status: {apiStatus}
                            </div>
                        </div>
                    </div>
                );
            }

            if (error && apiStatus === 'offline') {
                return (
                    <div className="dashboard">
                        <div className="error">
                            <h3>Unable to connect to API</h3>
                            <p>{error}</p>
                            <p>Make sure the Flask app is running on localhost:5000</p>
                            <button onClick={fetchData} className="refresh-btn">
                                Retry Connection
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="dashboard">
                    <header className="header">
                        <h1>üõ°Ô∏è Misinformation Detection Dashboard</h1>
                        <p>
                            Real-time monitoring and analysis of misinformation across social media and news sources
                            <span className={`status-indicator ${apiStatus === 'online' ? 'status-online' : 'status-offline'}`}></span>
                            Last updated: {lastUpdate.toLocaleTimeString()}
                            <span className={`api-status ${apiStatus}`}>
                                API: {apiStatus}
                            </span>
                        </p>
                    </header>

                    <nav className="nav-tabs">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                className={`nav-tab ${activeTab === tab.id ? 'active' : ''}`}
                                onClick={() => setActiveTab(tab.id)}
                            >
                                {tab.icon} {tab.label}
                            </button>
                        ))}
                        <button onClick={fetchData} className="refresh-btn">
                            üîÑ Refresh
                        </button>
                    </nav>

                    <main>
                        {activeTab === 'overview' && <OverviewTab data={data} />}
                        {activeTab === 'flagged' && <FlaggedTab data={data} />}
                        {activeTab === 'analytics' && <AnalyticsTab data={data} />}
                        {activeTab === 'sources' && <SourcesTab data={data} />}
                        {activeTab === 'sessions' && <SessionsTab data={data} />}
                    </main>
                </div>
            );
        }

        // Overview Tab Component
        function OverviewTab({ data }) {
            const { stats, summary } = data;

            return (
                <>
                    <div className="content-grid">
                        <div className="card metric-card">
                            <div className="metric-value">{stats?.total_flagged || 0}</div>
                            <div className="metric-label">Total Flagged</div>
                        </div>
                        <div className="card metric-card">
                            <div className="metric-value">{stats?.propaganda_count || 0}</div>
                            <div className="metric-label">Propaganda Detected</div>
                        </div>
                        <div className="card metric-card">
                            <div className="metric-value">{stats?.toxic_count || 0}</div>
                            <div className="metric-label">Toxic Content</div>
                        </div>
                        <div className="card metric-card">
                            <div className="metric-value">{stats?.bot_count || 0}</div>
                            <div className="metric-label">Bot Accounts</div>
                        </div>
                    </div>

                    <div className="content-grid">
                        <div className="card">
                            <h3>üìä System Performance</h3>
                            {summary ? (
                                <div>
                                    <p><strong>Total Sessions:</strong> {summary.total_sessions}</p>
                                    <p><strong>Articles Processed:</strong> {summary.total_articles_processed}</p>
                                    <p><strong>Overall Flag Rate:</strong> {summary.overall_flagging_rate?.toFixed(1)}%</p>
                                    <p><strong>Avg Success Rate:</strong> {summary.average_scraping_success_rate?.toFixed(1)}%</p>
                                </div>
                            ) : (
                                <p>Loading performance metrics...</p>
                            )}
                        </div>

                        <div className="card">
                            <h3>üè∑Ô∏è Content Breakdown</h3>
                            {summary ? (
                                <div>
                                    <p><strong>Propaganda:</strong> {summary.content_breakdown?.propaganda || 0}</p>
                                    <p><strong>Toxic:</strong> {summary.content_breakdown?.toxic || 0}</p>
                                    <p><strong>Bots:</strong> {summary.content_breakdown?.bots || 0}</p>
                                    <p><strong>Total Problematic:</strong> {summary.content_breakdown?.total_problematic || 0}</p>
                                </div>
                            ) : (
                                <p>Loading content breakdown...</p>
                            )}
                        </div>
                    </div>

                    <div className="content-grid full-width">
                        <div className="card">
                            <h3>üìà Detection Trends</h3>
                            <ContentChart data={data} />
                        </div>
                    </div>
                </>
            );
        }

        // Flagged Content Tab
        function FlaggedTab({ data }) {
            const { flagged } = data;

            return (
                <div className="content-grid full-width">
                    <div className="card">
                        <h3>üö© Recently Flagged Content ({flagged.length} items)</h3>
                        {flagged.length === 0 ? (
                            <p>No flagged content found. Run monitoring to detect misinformation.</p>
                        ) : (
                            <div>
                                {flagged.slice(0, 20).map(item => (
                                    <div key={item.id} className={`flagged-item ${item.label}`}>
                                        <div className="flagged-title">
                                            {item.content.split('\n')[0] || 'Untitled Content'}
                                        </div>
                                        <div className="flagged-meta">
                                            <span>üè∑Ô∏è {item.label} ({(item.confidence * 100).toFixed(1)}%)</span>
                                            <span>üë§ {item.username}</span>
                                            <span>üìÖ {new Date(item.timestamp).toLocaleString()}</span>
                                            {item.is_bot && <span>ü§ñ Bot Account</span>}
                                        </div>
                                        <div className="flagged-content">
                                            {item.content.length > 200 
                                                ? item.content.substring(0, 200) + '...'
                                                : item.content
                                            }
                                        </div>
                                        {item.url && (
                                            <a href={item.url} target="_blank" rel="noopener noreferrer" className="flagged-url">
                                                üîó {item.url}
                                            </a>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Analytics Tab
        function AnalyticsTab({ data }) {
            return (
                <div className="content-grid">
                    <div className="card">
                        <h3>üìä Classification Chart</h3>
                        <ClassificationChart data={data} />
                    </div>
                    <div className="card">
                        <h3>üìà Performance Metrics</h3>
                        <PerformanceChart data={data} />
                    </div>
                </div>
            );
        }

        // Sources Tab
        function SourcesTab({ data }) {
            const { summary } = data;

            return (
                <div className="content-grid full-width">
                    <div className="card">
                        <h3>üåê Source Performance Analysis</h3>
                        {summary?.recent_sessions ? (
                            <div>
                                {summary.recent_sessions.map((session, index) => (
                                    <div key={session.id || index}>
                                        <h4>Session {session.id} - {session.session_type}</h4>
                                        {Object.entries(session.sources_successful || {}).map(([source, count]) => (
                                            <div key={source} className="source-item">
                                                <span className="source-name">{source}</span>
                                                <div className="source-stats">
                                                    <span>Articles: {count}</span>
                                                    <span className="success-rate">
                                                        Success: {session.sources_attempted?.[source] 
                                                            ? ((count / session.sources_attempted[source]) * 100).toFixed(1)
                                                            : 'N/A'
                                                        }%
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p>No source performance data available.</p>
                        )}
                    </div>
                </div>
            );
        }

        // Sessions Tab
        function SessionsTab({ data }) {
            const { sessions } = data;

            return (
                <div className="content-grid full-width">
                    <div className="card">
                        <h3>‚è±Ô∏è Monitoring Sessions ({sessions.length})</h3>
                        {sessions.length === 0 ? (
                            <p>No monitoring sessions found.</p>
                        ) : (
                            <div>
                                {sessions.map(session => (
                                    <div key={session.id} className="session-item">
                                        <div className="session-info">
                                            <h4>Session {session.id} - {session.session_type}</h4>
                                            <div className="session-meta">
                                                üìÖ {new Date(session.start_time).toLocaleString()}
                                                {session.duration_seconds && 
                                                    ` ‚Ä¢ ‚è±Ô∏è ${session.duration_seconds.toFixed(1)}s`
                                                }
                                                ‚Ä¢ üìä {session.use_real_data ? 'Real Data' : 'Mock Data'}
                                            </div>
                                        </div>
                                        <div className="session-stats">
                                            <div>üì∞ {session.total_articles_analyzed} analyzed</div>
                                            <div>üö© {session.total_flagged} flagged</div>
                                            <div>üìà {session.flagging_rate?.toFixed(1)}% flag rate</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Chart Components
        function ContentChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current && data.stats) {
                    // Destroy existing chart
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Propaganda', 'Toxic', 'Bots', 'Reliable'],
                            datasets: [{
                                data: [
                                    data.stats.propaganda_count || 0,
                                    data.stats.toxic_count || 0,
                                    data.stats.bot_count || 0,
                                    data.stats.reliable_count || 0
                                ],
                                backgroundColor: [
                                    '#e74c3c',
                                    '#e67e22',
                                    '#9b59b6',
                                    '#27ae60'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="chart-container">
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        function ClassificationChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current && data.stats) {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Propaganda', 'Toxic', 'Bots', 'Reliable'],
                            datasets: [{
                                label: 'Count',
                                data: [
                                    data.stats.propaganda_count || 0,
                                    data.stats.toxic_count || 0,
                                    data.stats.bot_count || 0,
                                    data.stats.reliable_count || 0
                                ],
                                backgroundColor: [
                                    '#e74c3c',
                                    '#e67e22',
                                    '#9b59b6',
                                    '#27ae60'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="chart-container">
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        function PerformanceChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current && data.sessions) {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }

                    const ctx = canvasRef.current.getContext('2d');
                    const recentSessions = data.sessions.slice(0, 10).reverse();
                    
                    chartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: recentSessions.map(s => `Session ${s.id}`),
                            datasets: [{
                                label: 'Flagging Rate (%)',
                                data: recentSessions.map(s => s.flagging_rate || 0),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4
                            }, {
                                label: 'Success Rate (%)',
                                data: recentSessions.map(s => s.scraping_success_rate || 0),
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return (
                <div className="chart-container">
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        // Render the Dashboard
        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>